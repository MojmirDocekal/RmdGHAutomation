name: Compile R Markdown Document

on: 
  push:
    branches: 
      - main
    paths: 
      - '**.Rmd'
      - '**.bib'  # Also trigger on bibliography changes
  pull_request:
    paths:
      - '**. Rmd'
      - '**. bib'

jobs:
  compile-rmarkdown:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps: 
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Install R
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version:  'release'
      
      # Install pandoc (needed for R Markdown)
      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
      
      # Install comprehensive TeXLive for linguistics/scientific papers
      # This includes all the packages you mentioned (linguex, qtree, etc.)
      - name: Install TeXLive
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-humanities \
            texlive-bibtex-extra \
            texlive-science \
            texlive-publishers
          # linguex and qtree are in texlive-humanities and texlive-latex-extra
      
      # Install only essential R packages for rendering
      - name: Install R packages
        run: |
          R -e 'install.packages(c("rmarkdown", "knitr"), repos="https://cloud.r-project.org")'
      
      # Compile the R Markdown document to PDF
      # The keep_tex option helps with debugging LaTeX errors
      - name: Render R Markdown to PDF
        run:  |
          R -e 'rmarkdown::render("document. Rmd", output_format = rmarkdown::pdf_document(keep_tex = TRUE))'
      
      # Upload both PDF and intermediate . tex file for debugging
      - name:  Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pdf
          path: |
            document.pdf
            document.tex
          retention-days: 90